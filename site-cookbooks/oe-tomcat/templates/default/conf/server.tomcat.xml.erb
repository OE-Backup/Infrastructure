<?xml version='1.0' encoding='utf-8'?>
<!--
  Dynamically generated by Chef on <%= node['fqdn'] %>
  Local modifications will be overwritten by Chef.
-->

<Server port="8005" shutdown="SHUTDOWN">

  <!--
  <Listener className="org.apache.catalina.core.AprLifecycleListener" SSLEngine="on" />
  -->
  <Listener className="org.apache.catalina.core.JasperListener" />
  <Listener className="org.apache.catalina.core.JreMemoryLeakPreventionListener" />

<% if node['tomcat']['version'].to_i < 7 -%>
  <Listener className="org.apache.catalina.mbeans.JmxRemoteLifecycleListener" />
<% end -%>

<% unless node['tomcat']['jmx'].nil? -%>
  <Listener className="org.apache.catalina.mbeans.JmxRemoteLifecycleListener"
    rmiRegistryPortPlatform="<%= node['jmx']['rmiRegistryPortPlatform'] %>"
    rmiServerPortPlatform="<%= node['jmx']['rmiServerPortPlatform'] %>"
  />
<% end -%>

<Listener className="org.apache.catalina.mbeans.GlobalResourcesLifecycleListener" />
  <GlobalNamingResources>
    <Resource name="UserDatabase" auth="Container"
      type="org.apache.catalina.UserDatabase"
      description="User database that can be updated and saved"
      factory="org.apache.catalina.users.MemoryUserDatabaseFactory"
      pathname="conf/tomcat-users.xml"
      />
  </GlobalNamingResources>

  <Service name="Catalina">

    <Connector protocol="HTTP/1.1"
      port="<%= node['tomcat']['port'] %>"
      maxThreads="<%= node['tomcat']['maxThreads'] %>"
      connectionTimeout="20000"
      URIEncoding="UTF-8"
      <% if node['tomcat'].has_key?("proxy_port") -%>
      proxyPort="<%= node['tomcat']['proxy_port'] %>"
      <% end -%>
      redirectPort="<%= node['tomcat']['ssl_port'] %>"
      />

    <% 
      unless node['ssl'].nil? or
        node['ssl']['tomcat'].nil? or
        node['ssl']['tomcat']['keystore'].nil? 
    -%>
    <Connector protocol="HTTP/1.1"
      port="<%= node['tomcat']['ssl_port'] %>"
      maxThreads="<%= node['tomcat']['maxThreads'] %>"
      SSLEnabled="true"
      scheme="https"
      secure="true" 
      sslProtocol="TLS"
      <% if node['tomcat'].has_key?("ssl_proxy_port") -%>
      proxyPort="<%= node['tomcat']['ssl_proxy_port'] %>"
      <% end -%>
      keystoreType="JKS"
      keystoreFile="<%= node['ssl']['tomcat']['keystore'] %>"
      keystorePass="<%= node['ssl']['tomcat']['keystorePass'] %>"
      clientAuth="false" 
    />
    <% end -%>

    <Connector port="<%= node['tomcat']['ajp_port'] %>"
      protocol="AJP/1.3"
      tomcatAuthentication="<%= node['tomcat']['tomcat_auth'] %>"
      redirectPort="<%= node['tomcat']['ssl_port'] %>"
    />

    <Engine name="Catalina" defaultHost="localhost">

      <Realm className="org.apache.catalina.realm.UserDatabaseRealm"
        resourceName="UserDatabase"
      />

      <Host name="localhost"  appBase="webapps"
        unpackWARs="true" autoDeploy="true"
        xmlValidation="false" xmlNamespaceAware="false">
      </Host>

    </Engine>

  </Service>

</Server>

